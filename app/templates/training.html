{% extends "base.html" %}

{% block title %}ML Training{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ML Training - Session {{ session_id }}</h2>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <strong>Dataset Information:</strong>
                <ul>
                    <li>Images: {{ metadata.image_count }}</li>
                    <li>Processed: {{ metadata.processed_images }}</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Training Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="ml-config-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Model Type</label>
                                    <select class="form-select" name="model_type">
                                        <option value="simple_cnn">Simple CNN</option>
                                        <option value="deep_cnn">Deep CNN</option>
                                        <option value="resnet">ResNet</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Learning Rate</label>
                                    <select class="form-select" name="learning_rate">
                                        <option value="0.0001">0.0001</option>
                                        <option value="0.001" selected>0.001</option>
                                        <option value="0.01">0.01</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Batch Size</label>
                                    <select class="form-select" name="batch_size">
                                        <option value="16">16</option>
                                        <option value="32" selected>32</option>
                                        <option value="64">64</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Epochs</label>
                                    <input type="number" class="form-control" name="num_epochs" value="10" min="1" max="50">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Optimizer</label>
                                    <select class="form-select" name="optimizer">
                                        <option value="Adam" selected>Adam</option>
                                        <option value="SGD">SGD</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Dropout Rate</label>
                                    <input type="number" class="form-control" name="dropout_rate" value="0.3" min="0.1" max="0.5" step="0.1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="start-training-btn">
                                Start Training
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div id="training-progress" class="mb-4" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Training Progress</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="training-progress-bar" role="progressbar" 
                         style="width: 0%" aria-valuenow="0" aria-valuemin="0" 
                         aria-valuemax="100">0%</div>
                </div>
                
                <div id="training-message" class="mb-3">Initializing...</div>
                
                <div id="metrics-container" class="row" style="display: none;">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Training Metrics</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <td>Training Loss:</td>
                                        <td id="train-loss">-</td>
                                    </tr>
                                    <tr>
                                        <td>Validation Loss:</td>
                                        <td id="val-loss">-</td>
                                    </tr>
                                    <tr>
                                        <td>Training Accuracy:</td>
                                        <td id="train-acc">-</td>
                                    </tr>
                                    <tr>
                                        <td>Validation Accuracy:</td>
                                        <td id="val-acc">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Final Metrics</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <td>Accuracy:</td>
                                        <td id="final-accuracy">-</td>
                                    </tr>
                                    <tr>
                                        <td>F1 Score:</td>
                                        <td id="final-f1">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="mlflow-link-container" class="mt-3" style="display: none;">
                    <a id="mlflow-link" href="#" class="btn btn-info" target="_blank">
                        View in MLflow
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sessionId = "{{ session_id }}";
        const form = document.getElementById('ml-config-form');
        const startBtn = document.getElementById('start-training-btn');
        const progressSection = document.getElementById('training-progress');
        const progressBar = document.getElementById('training-progress-bar');
        const messageEl = document.getElementById('training-message');
        const metricsContainer = document.getElementById('metrics-container');
        const mlflowLinkContainer = document.getElementById('mlflow-link-container');
        const mlflowLink = document.getElementById('mlflow-link');
        
        // Socket.IO connection
        const socket = io();
        
        // Join the ML room for this session
        socket.emit('ml_connect', { session_id: sessionId });
        
        // Check initial status
        checkTrainingStatus();
        
        // Listen for ML status updates
        socket.on('ml_status', function(data) {
            updateUIWithStatus(data);
        });
        
        // Form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Disable form
            startBtn.disabled = true;
            startBtn.innerHTML = 'Starting...';
            
            // Get form data
            const formData = new FormData(form);
            const config = {};
            
            for (const [key, value] of formData.entries()) {
                config[key] = value;
            }
            
            // Start training
            fetch(`/api/train/${sessionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    startBtn.disabled = false;
                    startBtn.innerHTML = 'Start Training';
                } else {
                    // Show progress section
                    progressSection.style.display = 'block';
                    form.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to start training');
                startBtn.disabled = false;
                startBtn.innerHTML = 'Start Training';
            });
        });
        
        // Function to check training status
        function checkTrainingStatus() {
            fetch(`/api/training-status/${sessionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'training' || data.status === 'complete') {
                        // Training is in progress or complete
                        progressSection.style.display = 'block';
                        form.disabled = true;
                        startBtn.disabled = true;
                        
                        if (data.status === 'complete') {
                            // Training is complete
                            updateUIWithFinalMetrics(data);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                });
        }
        
        // Function to update UI with status
        function updateUIWithStatus(data) {
            // Update progress bar
            const progress = data.progress || 0;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            
            // Update message
            messageEl.textContent = data.message || 'Processing...';
            
            // Handle different statuses
            if (data.status === 'processing') {
                metricsContainer.style.display = 'flex';
                
                // Update metrics if available
                if (data.metrics) {
                    document.getElementById('train-loss').textContent = 
                        data.metrics.train_loss ? data.metrics.train_loss.toFixed(4) : '-';
                    document.getElementById('val-loss').textContent = 
                        data.metrics.val_loss ? data.metrics.val_loss.toFixed(4) : '-';
                    document.getElementById('train-acc').textContent = 
                        data.metrics.train_acc ? (data.metrics.train_acc * 100).toFixed(2) + '%' : '-';
                    document.getElementById('val-acc').textContent = 
                        data.metrics.val_acc ? (data.metrics.val_acc * 100).toFixed(2) + '%' : '-';
                }
            } else if (data.status === 'complete') {
                // Training complete
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.remove('progress-bar-striped');
                progressBar.classList.add('bg-success');
                
                updateUIWithFinalMetrics(data);
            } else if (data.status === 'failed') {
                // Training failed
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.remove('progress-bar-striped');
                progressBar.classList.add('bg-danger');
                messageEl.innerHTML = `<strong>Error:</strong> ${data.message}`;
            }
        }
        
        // Function to update UI with final metrics
        function updateUIWithFinalMetrics(data) {
            metricsContainer.style.display = 'flex';
            
            if (data.metrics) {
                document.getElementById('final-accuracy').textContent = 
                    data.metrics.accuracy ? (data.metrics.accuracy * 100).toFixed(2) + '%' : '-';
                document.getElementById('final-f1').textContent = 
                    data.metrics.f1_score ? data.metrics.f1_score.toFixed(4) : '-';
            }
            
            // Show MLflow link if run_id is available
            if (data.mlflow_run_id) {
                mlflowLinkContainer.style.display = 'block';
                mlflowLink.href = `/mlflow/#/experiments/${data.mlflow_run_id}`;
            }
        }
    });
</script>
{% endblock %} 