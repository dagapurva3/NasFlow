{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Dataset Preprocessing - Session {{ session_id }}</h2>
    <div id="preprocessing-progress" class="mb-4">
        <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
        <div id="progress-message" class="mt-2"></div>
    </div>
    
    <form id="preprocessing-config">
        <div class="card mb-3">
            <div class="card-header">Image Processing Options</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label>Image Size</label>
                        <input type="number" name="image_width" value="224" class="form-control">
                        <input type="number" name="image_height" value="224" class="form-control mt-2">
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="random_hflip" checked>
                            <label class="form-check-label">Random Horizontal Flip</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="random_rotate" checked>
                            <label class="form-check-label">Random Rotation (±10°)</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label>Normalization</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Mean</span>
                            <input type="text" name="normalization_mean" 
                                   value="0.485, 0.456, 0.406" class="form-control">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">Std</span>
                            <input type="text" name="normalization_std" 
                                   value="0.229, 0.224, 0.225" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary" id="start-processing">
            Start Preprocessing
        </button>
    </form>
</div>

<script>
document.getElementById('preprocessing-config').onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const config = {};
    
    // Convert form data to proper types
    for (const [key, value] of formData.entries()) {
        if (key.startsWith('random_')) {
            // Convert checkboxes to booleans
            config[key] = value === 'on';
        } else if (key.includes('_mean') || key.includes('_std')) {
            // Convert comma-separated values to arrays
            config[key] = value.split(',').map(v => parseFloat(v.trim()));
        } else if (!isNaN(value)) {
            // Convert numbers to numbers
            config[key] = parseFloat(value);
        } else {
            config[key] = value;
        }
    }
    
    try {
        const response = await fetch(`/api/preprocess/{{ session_id }}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        
        if (response.ok) {
            // Disable form submission
            document.getElementById('start-processing').disabled = true;
            
            // Setup WebSocket for real-time updates
            const socket = io('/ws');
            
            socket.emit('join', { session_id: '{{ session_id }}' });
            
            socket.on('progress', (data) => {
                updateProgress(data);
            });
            
            socket.on('completed', (data) => {
                document.getElementById('progress-message').textContent = 'Preprocessing complete!';
                document.getElementById('progress-message').style.color = 'green';
                
                // Add a button to continue to training
                const continueBtn = document.createElement('button');
                continueBtn.className = 'btn btn-success mt-3';
                continueBtn.textContent = 'Continue to Training';
                continueBtn.onclick = () => { window.location.href = data.redirect; };
                document.getElementById('preprocessing-progress').appendChild(continueBtn);
            });
            
            socket.on('error', (data) => {
                document.getElementById('progress-message').textContent = data.message;
                document.getElementById('progress-message').style.color = 'red';
                document.getElementById('start-processing').disabled = false;
            });
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to start preprocessing');
        }
    } catch (error) {
        document.getElementById('progress-message').textContent = error.message;
        document.getElementById('progress-message').style.color = 'red';
    }
};

function updateProgress(data) {
    const progressBar = document.querySelector('.progress-bar');
    const progressMessage = document.getElementById('progress-message');
    
    progressBar.style.width = `${data.percentage}%`;
    progressBar.textContent = `${Math.round(data.percentage)}%`;
    progressBar.setAttribute('aria-valuenow', data.percentage);
    progressMessage.textContent = data.message;
}
</script>
{% endblock %}