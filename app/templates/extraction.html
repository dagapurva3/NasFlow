{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Extracting Dataset</h2>
    <div class="alert alert-info">
        <p>Extracting file: <strong>{{ filename }}</strong></p>
        <p id="extraction-message">Please wait while we extract your dataset...</p>
    </div>
    
    <div class="progress mb-4">
        <div id="extraction-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    
    <div id="extraction-status-message" class="mb-3"></div>
    
    <div id="extraction-actions" style="display: none;">
        <a id="continue-button" href="/preprocessing/{{ session_id }}" class="btn btn-primary">
            Continue to Preprocessing
        </a>
        <a href="/" class="btn btn-secondary">Back to Home</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io();
        socket.emit('join', { session_id: '{{ session_id }}' });
        
        socket.on('extraction_update', function(data) {
            const progressBar = document.getElementById('extraction-progress-bar');
            const message = document.getElementById('extraction-message');
            const statusMessage = document.getElementById('extraction-status-message');
            const actions = document.getElementById('extraction-actions');
            
            // Update progress bar
            progressBar.style.width = data.progress + '%';
            progressBar.textContent = data.progress + '%';
            progressBar.setAttribute('aria-valuenow', data.progress);
            
            // Update message
            message.textContent = data.message;
            
            // Handle different statuses
            if (data.status === 'complete') {
                progressBar.classList.remove('progress-bar-animated');
                statusMessage.textContent = 'Extraction completed successfully.';
                actions.style.display = 'block';
                
                // Auto-redirect after 3 seconds
                setTimeout(function() {
                    window.location.href = data.redirect;
                }, 3000);
            } 
            else if (data.status === 'failed') {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.remove('progress-bar-striped');
                progressBar.classList.add('bg-danger');
                statusMessage.textContent = 'Extraction failed: ' + data.message;
                statusMessage.style.color = 'red';
                
                const retryBtn = document.createElement('button');
                retryBtn.className = 'btn btn-warning';
                retryBtn.textContent = 'Retry Upload';
                retryBtn.onclick = function() { window.location.href = '/'; };
                actions.appendChild(retryBtn);
                actions.style.display = 'block';
            }
        });
    });
</script>
{% endblock %} 